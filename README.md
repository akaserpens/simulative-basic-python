# simulative-basic-python
Итоговый проект по модулю "Базовый Python + ООП"

## База данных

Проект работает с локальной базой данных, которую можно поднять в docker контейнере:

```
docker-compose -f var/docker/simbp/docker-compose.yaml up
```
Также поднимается контейнер с админкой. Админка доступна по адресу http://localhost:8080/

* Движок: PostgreSQL
* Сервер: db
* Имя пользователя: simbp
* Пароль: simbp
* База данных: simbp

Скрипт для инициализации структуры БД можно найти в файле var/docker/simbp/initdb/init.sql


## Запуск
```
./main.py --start "2025-12-25" --end "2025-12-26 13:00:00"
         --report-source (api|db) --report (gsheets|email) --email example@example.ru
         --no-fetch --truncate
```
Скрипт получает данные за указанный период и сохраняет их в БД. При необходимости строит отчет за тот же период и сохраняет его выбранным способом.

### Параметры запуска
* start - начало периода загрузки данных и построения отчета. Если не указано, используется текущая дата минус 24 часа.
* end - окончание периода для загрузки данных и построения отчета. Если не указано, к дате начала прибавляется 24 часа
* report-source - api | db. Если не передать параметр, отчет не будет построен. Если указано api, отчет будет построен на основании данных, выгруженных из API, без обращения к БД. Если указано db, данные для отчета будут выбраны из БД.
* report - gsheets | email. Если указано gsheets, отчет будет выгружен на [Google Sheets](https://docs.google.com/spreadsheets/d/1cG_A8vxdrwmjZ79UL5D_Ein-Z7hq68pATJLBI8784eg/). Если указано email, отчет будет отправлен на email
* email - адрес, на который нужно отправить отчет, если report=email
* no-fetch - если передать параметр, то этап выгрузки данных из API будет пропущен. Можно использовать для случаев, когда отчет строится из БД, и данные в ней уже есть
* truncate - если передать параметр, перед выполнением скрипта будут удалены все имеющиеся данные о попытках из БД.

Нижеследующий пример удалит все данные из БД, выгрузит новые данные с 2025-12-25 00:00:00 по 2025-12-25 12:00:00, построит отчет на основе данных API и отправит его на email example@example.ru:
```
./main.py --truncate --start "2025-12-25" --end "2025-12-25 12:00:00" --report-source api --report email --email example@example.ru 
```

Отчеты в Google Sheets можно найти в [таблице](https://docs.google.com/spreadsheets/d/1cG_A8vxdrwmjZ79UL5D_Ein-Z7hq68pATJLBI8784eg/).

## Конфигурация
Проект конфигурируется через файл config.ini в корне проекта

* database - параметры подключения к БД
  * host
  * port
  * user
  * password
  * database

* logging - настройки логирования
  * path - путь к файлам с логами. Если оставить пустым, логи будут выводиться в консоль
  * level - уровень логирования (debug | info | warning | error | critical). Внимание! Если указать debug, будут логироваться все SQL запросы, что может привести к большому объему логирования.
  * keep_days - сколько дней хранить файлы с логами. Логи старше будут удалены при запуске скрипта

* itresume - настройки интеграции с API
  * client
  * client_key
  * timeout - таймаут для чтения данных

* mailer - настройки отправки почты (отчетов)
  * server - адрес SMTP сервера
  * username - логин для подключения к SMTP серверу
  * password - пароль для подключения к SMTP серверу
  * sender - имя отправителя. Указывается в поле "От" при отправке отчета

* gsheets - настройки работы в Google Sheet
  * credentials - путь к файлу для авторизации сервисного аккаунта
  * spreadsheet_key - id таблицы, в которую выгружается отчет
  * sheet_name - название листа с отчетами